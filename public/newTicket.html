<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back Informática | Novo Chamado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <back-informatica-navbar></back-informatica-navbar>

    <main class="container mx-auto px-4 py-6 flex-grow">

        <div class="mb-6 flex items-center space-x-3">
            <a href="tickets.html" class="text-gray-500 hover:text-blue-600 transition duration-150 p-2 rounded-full hover:bg-gray-200">
                <i data-feather="arrow-left" class="w-6 h-6"></i>
            </a>
            <a href="tickets.html" class="text-3xl font-bold text-gray-800 hover:text-blue-600 transition duration-150">Voltar</a>
        </div>

        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 max-w-5xl mx-auto">
            <form class="space-y-6" id="new-ticket-form">

                <div class="border-b-2 border-blue-600 pb-2 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Preencha os dados abaixo</h2>
                </div>

                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center border-b border-gray-300 pb-2">
                        <i data-feather="user" class="w-5 h-5 mr-2 text-blue-600"></i> Dados do Solicitante
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="requester-name-new" class="block text-sm font-medium text-gray-700 mb-1">Nome do Solicitante <span class="text-red-500">*</span></label>
                            <input type="text" id="requester-name-new" name="solicitante" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="requester-phone-new" class="block text-sm font-medium text-gray-700 mb-1">Telefone <span class="text-red-500">*</span></label>
                            <input type="tel" id="requester-phone-new" name="telefone" required placeholder="(XX) XXXXX-XXXX" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <div class="col-span-1 relative">
                            <label for="requester-secretary" class="block text-sm font-medium text-gray-700 mb-1">Secretaria <span class="text-red-500">*</span></label>
                            <select id="requester-secretary" name="secretaria" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 appearance-none bg-white pr-8">
                                <option value="">Selecione a Secretaria</option>
                                <option value="Secretaria de Educação">Secretaria de Educação</option>
                                <option value="Secretaria de Saúde">Secretaria de Saúde</option>
                                <option value="Secretaria da Fazenda">Secretaria da Fazenda</option>
                                <option value="Secretaria de Administração">Secretaria de Administração</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 bottom-0">
                                <i data-feather="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <div class="col-span-1">
                            <label for="requester-sector" class="block text-sm font-medium text-gray-700 mb-1">Setor <span class="text-red-500">*</span></label>
                            <input type="text" id="requester-sector" name="setor" required placeholder="Ex: Protocolo, 5º Andar" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <div class="col-span-full">
                            <label for="requester-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço (Localização do Equipamento) <span class="text-red-500">*</span></label>
                            <input type="text" id="requester-address" name="endereco" required placeholder="Ex: Rua A, 123 - Sala 101" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center border-b border-gray-300 pb-2">
                        <i data-feather="monitor" class="w-5 h-5 mr-2 text-blue-600"></i> Dados do Equipamento
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 relative">
                            <label for="equipment-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Equipamento <span class="text-red-500">*</span></label>
                            <select id="equipment-type" name="tipo_equipamento" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 appearance-none bg-white pr-8">
                                <option value="">Selecione o Tipo</option>
                                <option value="Notebook">Notebook</option>
                                <option value="Desktop">Desktop</option>
                                <option value="Impressora">Impressora</option>
                                <option value="Servidor">Servidor</option>
                                <option value="Rede/Internet">Rede/Internet</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 bottom-0">
                                <i data-feather="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <div class="col-span-1">
                            <label for="equipment-asset" class="block text-sm font-medium text-gray-700 mb-1">Patrimônio/Etiqueta (Obrigatório)</label>
                            <input type="text" id="equipment-asset" name="patrimonio" placeholder="Ex: 123456" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            <p class="mt-1 text-xs text-gray-500">Se não souber, use "N/A".</p>
                        </div>
                        <div class="col-span-1">
                            <label for="equipment-model" class="block text-sm font-medium text-gray-700 mb-1">Modelo/Série (Opcional)</label>
                            <input type="text" id="equipment-model" name="modelo" placeholder="Ex: HP ProBook 450 G8" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <div class="col-span-1">
                            <label for="equipment-location" class="block text-sm font-medium text-gray-700 mb-1">Ponto de Rede (Opcional)</label>
                            <input type="text" id="equipment-location" name="ponto_rede" placeholder="Ex: RJ45-10" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            <p class="mt-1 text-xs text-gray-500">Se aplicável (computadores e impressoras de rede).</p>
                        </div>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center border-b border-gray-300 pb-2">
                        <i data-feather="message-square" class="w-5 h-5 mr-2 text-blue-600"></i> Descrição do Problema
                    </h3>
                    <div class="col-span-full">
                        <label for="ticket-description" class="block text-sm font-medium text-gray-700 mb-1">Descreva o Problema Detalhadamente <span class="text-red-500">*</span></label>
                        <textarea id="ticket-description" name="descricao" rows="5" required placeholder="Ex: A tela do monitor não liga, o computador emite um bipe e não inicia. O problema começou hoje pela manhã." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></textarea>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center border-b border-gray-300 pb-2">
                        <i data-feather="paperclip" class="w-5 h-5 mr-2 text-blue-600"></i> Anexos (Opcional)
                    </h3>
                    <div class="col-span-full">
                        <label for="ticket-files" class="block text-sm font-medium text-gray-700 mb-1">Anexar Imagens/Arquivos</label>
                        <input type="file" id="ticket-files" name="files" multiple accept="image/*,.pdf" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100 transition duration-150
                            ">
                        <p class="mt-1 text-xs text-gray-500">Máximo 5 arquivos (Imagens ou PDF).</p>
                    </div>
                </div>

                <div class="pt-4 flex justify-end space-x-4">
                    <button type="button" onclick="window.location.href='tickets.html'"
                            class="py-3 px-6 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="py-3 px-6 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 flex items-center justify-center">
                        <i data-feather="save" class="w-5 h-5 mr-2"></i> Abrir Chamado
                    </button>
                </div>

            </form>
        </div>
    </main>

    <script>
        // ===================================================
        // 0. VERIFICAÇÃO DE AUTENTICAÇÃO (Padronizado)
        // ===================================================
        (function checkAuth() {
            // Verifica se existe uma sessão ativa (seja sessionStorage ou localStorage)
            const user = sessionStorage.getItem('back_informatica_user') || localStorage.getItem('back_informatica_user');

            // Se o usuário não estiver autenticado, redireciona para a página de login (index.html)
            if (!user) {
                window.location.replace('index.html');
                return;
            }

            // Em uma aplicação real, você validaria o token do usuário ou o status dele aqui.
            console.log(`Usuário autenticado: ${user}. Carregando página.`);
        })();

        // ===================================================
        // 1. FUNÇÃO LOGOUT (Padronizado)
        // ===================================================
        function logout() {
            // Remove a sessão de ambas as áreas de armazenamento
            sessionStorage.removeItem('back_informatica_user');
            localStorage.removeItem('back_informatica_user');

            // Redireciona para a página de login
            window.location.replace('index.html');
        }

        // ===================================================
        // 2. WEB COMPONENT: BackInformaticaNavbar (Padronizado)
        // ===================================================
        class BackInformaticaNavbar extends HTMLElement {
            connectedCallback() {
                // Obtém o nome do arquivo da URL atual (Ex: dash.html)
                const currentPath = window.location.pathname.split('/').pop();

                const links = [
                    { href: "dash.html", text: "Dashboard" },
                    { href: "tickets.html", text: "Chamados" },
                    { href: "reports.html", text: "Relatórios" },
                ];

                const navLinksHtml = links.map(link => {
                    // Verifica se o link atual corresponde à página
                    const isActive = currentPath === link.href;
                    // Classes de destaque
                    const activeClasses = "font-medium text-blue-600 border-b-2 border-blue-600 pb-1";
                    const inactiveClasses = "hover:text-blue-600 transition duration-150";
                    const classes = isActive ? activeClasses : inactiveClasses;
                    return `<li><a href="${link.href}" class="${classes}">${link.text}</a></li>`;
                }).join('');

                this.innerHTML = `
                    <header class="bg-white shadow-md">
                        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                            <div class="text-2xl font-bold text-blue-600">Back Informática - Soluções técnologicas</div>
                            <nav class="hidden md:block">
                                <ul class="flex space-x-6 text-gray-600">
                                    ${navLinksHtml}
                                </ul>
                            </nav>
                            <div class="flex items-center space-x-4">
                                <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500" onclick="alert('Notificações (Simulado)')">
                                    <i data-feather="bell" class="w-5 h-5"></i>
                                </button>
                                <img src="https://ui-avatars.com/api/?name=User&background=3B82F6&color=fff&bold=true" alt="User Avatar" class="w-9 h-9 rounded-full border-2 border-blue-400" onclick="alert('Perfil (Simulado)')">
                                <button class="p-2 rounded-lg bg-gray-100 hover:bg-red-100 text-red-600" onclick="logout()">
                                    <i data-feather="log-out" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </header>
                `;
                // Garante que os ícones do feather sejam substituídos no Light DOM
                feather.replace();
            }
        }
        customElements.define('back-informatica-navbar', BackInformaticaNavbar);

        // ===================================================
        // 3. FUNÇÃO DE SUBMISSÃO DE FORMULÁRIO (Específico desta página)
        // ===================================================
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();

            document.getElementById('new-ticket-form').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(e.target);
                // Adiciona a data/hora atual (simulação de timestamp do chamado)
                formData.append('date_opened', new Date().toISOString());

                // Em uma aplicação real, você enviaria o formData diretamente para a API.
                // Aqui faremos uma simulação de comunicação com o backend/Vercel.

                // Prepara os dados (incluindo arquivos) para envio
                const dataToSend = new FormData();
                for (let [key, value] of formData.entries()) {
                    dataToSend.append(key, value);
                }

                try {
                    // Simulação de chamada de API para Vercel
                    // Substitua '/api/chamados' pelo endpoint real da sua API
                    const response = await fetch('/api/chamados', {
                        method: 'POST',
                        // NÃO defina Content-Type; o FormData (navegador) o define corretamente como multipart/form-data
                        body: dataToSend
                    });

                    // Tenta ler o JSON do resultado (sucesso ou erro)
                    const result = await response.json();

                    if (response.ok) {
                        // Chamado criado com sucesso
                        alert(`✅ Chamado ${result.id || 'NOVO'} registrado com sucesso! Redirecionando...`);

                        // Limpa o formulário e redireciona
                        e.target.reset();
                        window.location.href = "tickets.html";
                    } else {
                        // Erro da API (ex: dados incompletos - status 400, ou erro 500 interno)
                        alert(`❌ Erro ao registrar chamado: ${result.error || 'Verifique o console para mais detalhes.'}`);
                        console.error("Erro da API:", result);
                    }

                } catch (error) {
                    // Erro de rede ou outro erro de execução (ex: CORS, API offline)
                    alert(`❌ Falha na comunicação com o servidor: ${error.message}. Verifique se o backend está no ar no Vercel.`);
                    console.error("Erro de Rede:", error);
                }
            });
        });
    </script>
</body>
</html>